<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>第 2 页 | DeiMo&#39;s blog</title>
  <meta name="author" content="DeiMo">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="DeiMo&#39;s blog"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">DeiMo&#39;s blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>DeiMo&#39;s blog<span class="blink-fast">∎</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart blink-slow"></i>
      aGVsbG8gd29ybGQ=
</div>    
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/11/20/微信小程序踩坑记/" >微信小程序踩坑记</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-11-20  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>曾有一段时间，一个叫”包你说”的小程序风靡微信平台，据产品大佬们的调查分析，日流水近百万，每日纯利润达十万~如此可观的收益，公司自然是想着要”截流”了~于是乎…这个重任就落到了本菜菜身上…如果你还不知道”包你说”的话…建议你先尝试着体验下，体验后你就发现，所谓的包你说，最大的难点无非就是在那个语音识别上…其它地方一如正常的CRUD…当然还有微信的小程序支付…让我郁闷了一阵</p>
<h2 id="踩坑一：微信小程序支付"><a href="#踩坑一：微信小程序支付" class="headerlink" title="踩坑一：微信小程序支付"></a>踩坑一：微信小程序支付</h2><p>先说简单的小程序支付吧…如果你对支付类业务比较熟悉，你总是能够发现，无论是原生支付，还是第三方支付…无论哪个平台…其最核心的步骤无外乎两步：<strong><strong>下单</strong></strong>  and  <strong><strong>通知</strong></strong> </p>
<p>根据不同的支付文档，有时需要客户端访问商户系统，由商户后端下单，成功后返回客户端，有时这是由商户系统生成下单参数，由客户端去请求下单。而微信的小程序支付则是后一种…嗯，这到没什么…不过需要注意的是…微信的小程序支付文档上有个<strong><strong>再签名</strong></strong>过程，同时，一定要注意<strong><strong>字段名</strong></strong>和<strong><strong>字段示例值</strong></strong> ！！！我就是被可恶的微信字段名坑得不浅…当然这也怨我自己粗心大意…其它诸如签名算法并没有什么难度的…贴一张图以示提醒了<img src="/img/wxapp/wxapp_pay1.jpeg" alt="小程序支付流程"> <img src="/img/wxapp/wxapp_pay2.jpeg" alt="小程序支付参数"></p>
<p>看到了吗…那个字段的示例值…更可恶的是…下单时的文档参数说明使用的是snakeCase，到了这里…全部变成camelCase…完全看心情有木有…没办法…也怨我看文档不仔细吧…</p>
<h2 id="踩坑二：微信语音识别"><a href="#踩坑二：微信语音识别" class="headerlink" title="踩坑二：微信语音识别"></a>踩坑二：微信语音识别</h2><p>在完成大概所有的CRUD和支付功能后…开始去玩…看起来最高大上的”语音识别”功能…我们最终选取的语音识别平台是百度…原因嘛…因为它免费…不过话又说起来…百度的语音识别接起来…还真挺简单的…直接提供了pip包，非常方便集成在flask框架中，我按照了示例…自己测试了文件上传…又调用百度语音识别api成功后…觉得自己大事已成…万万没想到的是…微信的语音文件格式并不可以被百度语音直接识别…WTF！怎么办…当时考虑使用讯飞…以为它可以转万能的语音格式…官方查阅之…原来不是…那就只有一种办法了…自行转码…于是又去搜索python的音频转码库…然而都没有对微信那种语音文件格式的支持…所以没办法了…到了这里…要么使用C语言…自己编写转码库和程序…让C调用…要么…嗯…使用第三方外部转码程序…好在Python和Unix/Linux对调用第三方应用支持比较好，这点没什么难度…那么话又说回来了…微信的语音文件到底是什么格式呢？百度之…大佬们众说纷坛…不过一个比较可信的主流的观点是<strong><strong>SILK</strong></strong>文件格式…嗯…于是各种搜索…终于让我找到了一款神器：ffmpeg万能解码器，支持丰富cli处理！在研究使用ffmpeg的时候…发现了 一个有趣的词…<strong><strong>Hall of Shame</strong></strong>有兴趣的朋友们可以自己去看看鹅厂的黑历史…然鹅…一番折腾后发现…ffmpeg并没有支持silk音频的解码库…需要自己额外下载…WTF！后来我又百度之…终于…发现了这位大佬,<a href="https://github.com/kn007/silk-v3-decoder" target="_blank" rel="noopener">传送门</a>，于是我按照文档…发现…居然告诉我这个<img src="/img/wxapp/decoder_fail.jpg" alt="转码错误"></p>
<p>WTF！不是标准SILK格式，那是什么？！千翻查找…叫我发现了这个…<a href="http://www.iosre.com/t/topic/3199" target="_blank" rel="noopener">传送门</a>，原来是在文件头信息中多了一个无用的空字节…于是…我在自己的mac中搜索微信接收到的语音文件，发现是.aud.silk结尾…嗯，应该称之为silk变种文件比较合适。于是按照思路…先去掉第一个字符…然后转码…这次果然有效！！！然后再调用百度语音识别，居然…成功了！不过值得一提的是…我在转码时，没有使用那个Shell脚本，而是用到了<a href="https://github.com/Kronopath/SILKCodec" target="_blank" rel="noopener">这个</a>，这份转码库的用法很简单：download下来后，进入ARM平台，然后make编译出可执行程序…编译过程可能会提示你安装一些编译的工具…（如果你没安装的话）之后就可以使用python去调用这个外部的第三方的程序了。这样就实现了微信的语音文件从上传到转码再到识别的过程，初步完成该核心功能，后续的识别率优化…可以考虑比对拼音…这样就可以避免同音不同字的识别尴尬，在一定程度上…提高识别率。</p>
<h2 id="踩坑三：微信小程序的通知"><a href="#踩坑三：微信小程序的通知" class="headerlink" title="踩坑三：微信小程序的通知"></a>踩坑三：微信小程序的通知</h2><p>用过摩拜单车小程序的童鞋们肯定都知道，摩拜单车在解锁和开锁后都会向用户发送一条通知。好吧，其实这个通知没什么难度，唯一觉得比较不舒服的是它的参数…嗯，尤其你要注意对于微信的access_token间断刷新…这个使用定时任务+redis就可以很好处理。接下来就是通知的核心参数form_id对于该参数…如果有支付过程的话，这个参数就会好拿很多…如果没有的话…那就会稍稍麻烦…当然我也只是研究使用了…支付情形…剩下的情形留着以后再去考虑吧</p>

	
	</div>
  <a type="button" href="/2017/11/20/微信小程序踩坑记/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/09/20/mysql中GROUP-CONCAT的长度问题/" >mysql中GROUP_CONCAT的长度问题</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-09-20  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>在mysql中，有个函数叫“GROUP_CONCAT”，平常使用可能发现不了问题，然而一旦数据量增大时，会发现内容被截取了！！！是的，你没看错，就是被截取了！！真的是非常令人蛋疼的问题呀，尤其是在类似聚合分组的业务，将数据反馈给客户端时，就更为严重了！多番查找折腾后发现，原来…<br>MYSQL内部对这个是有设置的，默认不设置的长度是1024，可以通过使用<code>show variables like &quot;group_concat_max_len</code>命令来查看该变量值<img src="/img/mysql/group_concat.png" alt="group_concat_max_len"></p>
<p>想要指定GROUP_CONCAT的长度有两种方法：</p>
<ol>
<li><p>修改变量 group_concat_max_len的值</p>
<ul>
<li><p>修改session变量，只对该连接客户有效</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> [<span class="keyword">SESSION</span>] group_concat_max_len=<span class="number">102400</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改global变量，对所有连接都生效</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> group_concat_max_len=<span class="number">102400</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>修改配置文件（全局生效）</p>
</li>
</ol>
<p>在mysql启动的配置文件下，进行设置，各平台下配置文件存放的目录不同，配置文件的具体存放位置，不是本文要讨论的内容</p>
<p>以我的mac os系统为例，我已经将mysql的配置文件写在/etc目录下，只需要在mysqld节点下group_concat_max_len = [size] (size是你定义的大小，上限为4294967295)<img src="/img/mysql/group_concat_len.png" alt="group_concat_len"></p>
<p>曾经看到过一些文章的说法是将group_concat_max_len设置为-1，然后就可以达到上限4294967295，我在自己的机器下试了试，发现<strong>并不可以</strong>…我的系统是mac os 10.12 ，mysql的版本是5.7.19</p>
<p>本文参考自CSDN，<a href="http://blog.csdn.net/alibert/article/details/51019351" target="_blank" rel="noopener">原文地址</a></p>

	
	</div>
  <a type="button" href="/2017/09/20/mysql中GROUP-CONCAT的长度问题/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/09/12/mysql_delete_problem/" >mysql非主键删除记录</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-09-12  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>这几天在使用mysql过程中发现了这样一个有趣问题：如果在执行delete操作时，where子句不是直接指定条件，mysql就会报错，内容如下：</p>
<blockquote>
<p>Error Code: 1175. You are using safe update mode and you tried to update a table without a WHERE that uses a KEY column To disable safe mode, toggle the option in Preferences -&gt; SQL Editor and reconnect.</p>
</blockquote>
<p>查阅官方的手册后，官方时如此介绍的：</p>
<blockquote>
<p>For beginners, a useful startup option is <a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-command-options.html#option_mysql_safe-updates" target="_blank" rel="noopener"><code>--safe-updates</code></a> (or <a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-command-options.html#option_mysql_safe-updates" target="_blank" rel="noopener"><code>--i-am-a-dummy</code></a>, which has the same effect). It is helpful for cases when you might have issued a <code>DELETE FROM *tbl_name*</code> statement but forgotten the <code>WHERE</code> clause. Normally, such a statement deletes all rows from the table. With <a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-command-options.html#option_mysql_safe-updates" target="_blank" rel="noopener"><code>--safe-updates</code></a>, you can delete rows only by specifying the key values that identify them. This helps prevent accidents.</p>
</blockquote>
<p>原来mysql为了避免出现初学者在执行delete操作时未制定where条件导致整个表被删除，因此在系统变量中开启了<strong>SAVE-UPDATES</strong>模式，这样就能有效减少错误的产生了。</p>
<p><strong>SAVE-UPDATES</strong>下有3个作用：这里就直接po出文档了</p>
<ul>
<li>You are not permitted to execute an <a href="https://dev.mysql.com/doc/refman/5.7/en/update.html" target="_blank" rel="noopener"><code>UPDATE</code></a> or <a href="https://dev.mysql.com/doc/refman/5.7/en/delete.html" target="_blank" rel="noopener"><code>DELETE</code></a> statement unless you specify a key constraint in the <code>WHERE</code> clause or provide a <code>LIMIT</code> clause (or both)</li>
<li>The server limits all large <a href="https://dev.mysql.com/doc/refman/5.7/en/select.html" target="_blank" rel="noopener"><code>SELECT</code></a> results to 1,000 rows unless the statement includes a <code>LIMIT</code> clause</li>
<li>The server aborts multiple-table <a href="https://dev.mysql.com/doc/refman/5.7/en/select.html" target="_blank" rel="noopener"><code>SELECT</code></a> statements that probably need to examine more than 1,000,000 row combinations</li>
</ul>
<p>综上，可以使用如下办法解决</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> SQL_SAVE_UPDATES = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>并不建议全局设置该变量，小心驶得万年船，尤其对经验不足童鞋来说~</p>
<p>更多内容请看这里，<a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-tips.html" target="_blank" rel="noopener">传送门</a></p>

	
	</div>
  <a type="button" href="/2017/09/12/mysql_delete_problem/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/09/05/python多线程技术-二/" >python多线程技术(二)</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-09-05  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>在《python多线程技术(一)》篇当中，曾粗略介绍了多线程技术及运行状态，及python对于多线程的支持和简单实用，还有印象的朋友一定还记得python中实现多线程的两种方式吧，如果不熟悉的话，建议你先去读一读我上一篇的博文哦🤓</p>
<p>本篇是python多线程技术的精华所在，在真实项目开发中所使用到的多线程编程模型大部分都可以在我将要给出的代码示例中找到，如果本篇的内容过于繁多的话，按照我一如既往，短小精悍的写作特点来看的话～我也许还会写上第三篇哦😛</p>
<h2 id="常见线程运行模型"><a href="#常见线程运行模型" class="headerlink" title="常见线程运行模型"></a>常见线程运行模型</h2><p>在开始撸码之前，我们还是看看的常见的线程模型有哪些～一起看看这些言简意赅，图文并茂的示意图（感谢麦子学院丁敬香老师提供的教学资料）</p>
<h5 id="1-井水不犯河水"><a href="#1-井水不犯河水" class="headerlink" title="1.井水不犯河水"></a>1.井水不犯河水<img src="/img/pythread/module1.png" alt="井水不犯河水"></h5><h5 id="2-独木桥上相遇－线程等待"><a href="#2-独木桥上相遇－线程等待" class="headerlink" title="2.独木桥上相遇－线程等待"></a>2.独木桥上相遇－线程等待<img src="/img/pythread/module2.png" alt="独木桥上相遇－线程等待"></h5><h5 id="3-甘当幕后英雄－后台线程"><a href="#3-甘当幕后英雄－后台线程" class="headerlink" title="3.甘当幕后英雄－后台线程"></a>3.甘当幕后英雄－后台线程<img src="/img/pythread/module3.png" alt="甘当幕后英雄－后台线程"></h5><h5 id="4-我先用你后用－线程同步"><a href="#4-我先用你后用－线程同步" class="headerlink" title="4. 我先用你后用－线程同步"></a>4. 我先用你后用－线程同步<img src="/img/pythread/module4.png" alt="我先用你后用－线程同步"></h5><h5 id="5-操作也有先后－线程同步"><a href="#5-操作也有先后－线程同步" class="headerlink" title="5.操作也有先后－线程同步"></a>5.操作也有先后－线程同步<img src="/img/pythread/module5.png" alt="操作也有先后－线程同步"></h5><h5 id="6共享要悠着用－线程同步"><a href="#6共享要悠着用－线程同步" class="headerlink" title="6共享要悠着用－线程同步"></a>6共享要悠着用－线程同步<img src="/img/pythread/module6.png" alt="共享要悠着用－线程同步"></h5><h5 id="7-我用完后叫你－线程通信"><a href="#7-我用完后叫你－线程通信" class="headerlink" title="7.我用完后叫你－线程通信"></a>7.我用完后叫你－线程通信<img src="/img/pythread/module7.png" alt="我用完后叫你－线程通信"></h5><h2 id="具体代码实例"><a href="#具体代码实例" class="headerlink" title="具体代码实例"></a>具体代码实例</h2><p>#####1. 线程等待实例</p>
<p>在python的多线程编程中实现线程的等待非常容易，只需要调用线程对象的<strong>join(self, timeout=None)</strong>方法即可</p>
<p>被调用join()方法的线程会一直阻塞调用者的线程，直到自己结束（正常结束，或引发未处理异常），或超出timeout的时间。</p>
<p>1.1.1 一般情形</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">            print(<span class="string">'threading: '</span>, i)</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    t = MyThread()</span><br><span class="line">    t.start()</span><br><span class="line">    <span class="comment">#t.join()	# 取消注释即转变为线程等待情形</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        print(<span class="string">'Main:'</span>, i)</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br></pre></td></tr></table></figure>
<p>运行结果如下<br><img src="/img/pythread/th_join1.png" alt="非等待"></p>
<p>可以看到是两个线程交叉运行，如果我们需要在子线程运行完成后再运行主进程，调用<strong>join</strong>方法即可</p>
<p>1.1.2 等待情形</p>
<p>代码如上，取消<strong>join</strong>方法所在行的注释即可</p>
<p>运行结果如下<br><img src="/img/pythread/th_join2.png" alt="等待"></p>
<h5 id="2-守护线程（后台线程）"><a href="#2-守护线程（后台线程）" class="headerlink" title="2. 守护线程（后台线程）"></a>2. 守护线程（后台线程）</h5><p>在python中实现后台线程的情景相当容易，其步骤如下：</p>
<blockquote>
<p>1.建立线程                              </p>
<p>2.设置线程的daemon属性为True</p>
<p>3.启动线程                              </p>
</blockquote>
<p>需要注意的是被设定为后台运行的线程，会在主程序退出时主动自杀。</p>
<p>2.1.1 一般情形</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dmn</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""模拟后台线程的运行"""</span></span><br><span class="line">    print(<span class="string">'dmn start ...'</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>) <span class="comment"># 后台线程来不及结束，将会随着主线程的结束而退出</span></span><br><span class="line">    print(<span class="string">'dmn end.'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ndmn</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""非后台线程运行"""</span></span><br><span class="line">    print(<span class="string">'ndmn start ...'</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">'ndmn end.'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    d = threading.Thread(target=dmn)</span><br><span class="line">    <span class="comment">#d.daemon= True		# 模拟后台线程时，请取消次注释</span></span><br><span class="line">    n = threading.Thread(target=ndmn)</span><br><span class="line">    print(<span class="string">'Main statr'</span>)</span><br><span class="line">    d.start()</span><br><span class="line">    n.start()</span><br><span class="line">    print(<span class="string">'Main end.'</span>）</span><br></pre></td></tr></table></figure>
<p>运行结果如下<br><img src="/img/pythread/th_daem1.png" alt="非等待线程"></p>
<p>可以看到主线程结束后，两个线程也相继结束</p>
<p>2.2.2 守护线程情形</p>
<p>代码如上，取消注释后，运行结果如下<br><img src="/img/pythread/th_daem2.png" alt="守护线程"></p>
<p>可以看到主线程结束后，守护线程就自动退出，还来不及执行<em>print(‘dmn end.’)</em></p>
<h5 id="3-线程同步（重点，难点）"><a href="#3-线程同步（重点，难点）" class="headerlink" title="3. 线程同步（重点，难点）"></a>3. 线程同步（重点，难点）</h5><p>python中线程同步的方式纷繁复杂，多种多样，为处理不同业务情形提供相应的工具和概念。python的theading模块主要提供了以下<strong>3</strong>种线程同步的方式：</p>
<blockquote>
<p>1.指令锁（Lock）</p>
<p>2.条件变量（Condition）</p>
<p>3.信号量（Semaphore）</p>
</blockquote>
<h6 id="3-1-指令锁"><a href="#3-1-指令锁" class="headerlink" title="3.1 指令锁"></a>3.1 指令锁</h6><h6 id="3-2-条件变量"><a href="#3-2-条件变量" class="headerlink" title="3.2 条件变量"></a>3.2 条件变量</h6><h6 id="3-3-信号量"><a href="#3-3-信号量" class="headerlink" title="3.3 信号量"></a>3.3 信号量</h6>
	
	</div>
  <a type="button" href="/2017/09/05/python多线程技术-二/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/08/28/python多线程技术(一)/" >python多线程技术(一)</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-08-28  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>最近一直在学习python的当中多线程技术，感觉使用起来的确比java要方便多～正好乘这个机会，当作是一个记录和总结了</p>
<h2 id="多线程技术概述"><a href="#多线程技术概述" class="headerlink" title="多线程技术概述"></a>多线程技术概述</h2><p>1.进程与线程</p>
<ul>
<li>进程：正在运行中的程序</li>
<li>线程：进程中负责程序执行的控制单元（执行路径）一个进程可以有多个执行路径，称之为多线程</li>
</ul>
<p>2.多线程技术的意义</p>
<blockquote>
<p>开启多个线程是为了同时运行多部分代码，每一个线程都有自己运行的内容。这个内容就是多线程要执行的任务</p>
</blockquote>
<p>3.多线程的好处与弊端</p>
<ul>
<li><p>好处：解决了多部分程序同时运行的问题，由主机的操作系统给每个进程/线程安排一个小的时间片，</p>
<p>在所有进程/线程间快速循环，使得每个执行单位都得到CPU的执行时间。</p>
</li>
<li><p>弊端：线程太多反而会导致cpu处理效率的降低，这是因为应用程序的执行都是cpu做着快速的切换完成的，而这个切换是随机的。</p>
</li>
</ul>
<p>4.python中多线程局限性（这里的python如不加特殊说明都是指CPython）</p>
<blockquote>
<p>Python解释器内部使用了全局解释器锁（GIL），限制了一个Python程序只能在一个CPU核心上运行。</p>
</blockquote>
<p>所以…某种以上上…python语言的多线程特性…只是一个美丽的谎言…但这并不足以作为拒绝learning的理由，君不见node.js的异步单线程模型在大部分应用场合下～速度不都是杠杠滴嘛</p>
<h2 id="创建多线程的方式"><a href="#创建多线程的方式" class="headerlink" title="创建多线程的方式"></a>创建多线程的方式</h2><p>python当中封装了有专门针对多线程解决方案的threading模块，我们对于多线程技术的各种功能需求，都可以在此模块当中找到，挑几个重要的介绍下吧～<img src="/img/pythread/threadingmodule.jpg" alt="threadingmodule"></p>
<table>
<thead>
<tr>
<th style="text-align:center">类名</th>
<th style="text-align:center">功能描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Thread</td>
<td style="text-align:center">表示控制线程的类，封装线程对象一般属性和开启以及等待方法</td>
</tr>
<tr>
<td style="text-align:center">Lock</td>
<td style="text-align:center">指令锁，封装由同步所需的获取🔒和释放锁的方法</td>
</tr>
<tr>
<td style="text-align:center">RLock</td>
<td style="text-align:center">可重入锁，用于同一线程多次获取同一资源，相应地也要release匹配</td>
</tr>
<tr>
<td style="text-align:center">Condition</td>
<td style="text-align:center">条件变量，常用于生产者，消费者模型中的共享变量控制及线程间的通信</td>
</tr>
<tr>
<td style="text-align:center">Semaphore</td>
<td style="text-align:center">信号量，内部维护着一个计数器，可用于实现对稀缺资源的控制，如数据库连接池等</td>
</tr>
<tr>
<td style="text-align:center">Event</td>
<td style="text-align:center">事件，用于</td>
</tr>
</tbody>
</table>
<p>在python中有两种方式创建线程，以下来自Thread类doc说明</p>
<blockquote>
<p>There are two ways to specify the activity: by passing a callable object to the constructor, or by overriding the run() method in a subclass</p>
</blockquote>
<p>下面先介绍下Thread对象相关属性和方法，以及线程的创建方式<img src="/img/pythread/thread.png" alt="Thread对象"></p>
<ul>
<li><p>第一种方式：继承Thread类并重写run()方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">      	super().__init__()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        s = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">30</span>):</span><br><span class="line">            s += i;</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        print(s)</span><br><span class="line"> </span><br><span class="line">th = MyThread()</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二种方式：在实例化Thread对象时传入线程的运行目标任务（一个函数）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">thfun</span><span class="params">()</span>:</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">30</span>):</span><br><span class="line">        s += i;</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    print(s)</span><br><span class="line"></span><br><span class="line">th = threading.Thread(target=thfun)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>创建线程后即可调用 <strong>start()</strong>方法调用开启线程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">th.start()</span><br></pre></td></tr></table></figure>
<h2 id="多线程的运行状态"><a href="#多线程的运行状态" class="headerlink" title="多线程的运行状态"></a>多线程的运行状态</h2><p>引用某大佬的一幅图来解释吧，在此先膜拜下大佬～<img src="/img/pythread/threadstatus.png" alt="threadstatus"></p>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><p>受篇幅限制，本次关于python下多线程技术就暂且聊到这里了，太长的文章想必大佬们也没耐心看下去…相信这里的内容对任何有一定语言基础的朋友来说都是再容易不过了🤓～接下来的博主要更新的文章将是多线程技术中的核心与精华（不限语言），暂且剧透下吧😈：指令锁实现同步、条件变量模拟生产者消费者模型、信号量实现对稀缺资源的控制、使用事件实现线程间的通信…敬请期待，预计1～2篇，下次我会po上全部完整代码😎</p>

	
	</div>
  <a type="button" href="/2017/08/28/python多线程技术(一)/#more" class="btn btn-default more">阅读此文</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
     <a href="/" type="button" class="btn btn-default"><i class="fa fa-arrow-circle-o-left"></i> 上一页</a>
      

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
          <a type="button" class="btn btn-default disabled">下一页<i class="fa fa-arrow-circle-o-right"></i></a>
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="搜索" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>分类</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/Docker-CE/">Docker CE<span>1</span></a></li>
		
			<li><a href="/categories/Hexo/">Hexo<span>1</span></a></li>
		
			<li><a href="/categories/RabbitMQ/">RabbitMQ<span>1</span></a></li>
		
			<li><a href="/categories/Travis-CI-持续集成/">Travis.CI 持续集成<span>1</span></a></li>
		
			<li><a href="/categories/mysql/">mysql<span>2</span></a></li>
		
			<li><a href="/categories/python-多线程/">python 多线程<span>2</span></a></li>
		
			<li><a href="/categories/个人随笔/">个人随笔<span>2</span></a></li>
		
			<li><a href="/categories/后端/">后端<span>1</span></a></li>
		
			<li><a href="/categories/密码学/">密码学<span>1</span></a></li>
		
			<li><a href="/categories/微信小程序/">微信小程序<span>3</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>标签云</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/生活记录/">生活记录<span>2</span></a></li>
		
			<li><a href="/tags/问题记录-转载/">问题记录 转载<span>1</span></a></li>
		
			<li><a href="/tags/微信-原创教程/">微信 原创教程<span>2</span></a></li>
		
			<li><a href="/tags/语言基础/">语言基础<span>2</span></a></li>
		
			<li><a href="/tags/微信-问题记录/">微信 问题记录<span>1</span></a></li>
		
			<li><a href="/tags/Python-AES-RSA/">Python AES RSA<span>1</span></a></li>
		
			<li><a href="/tags/运维，性能监控/">运维，性能监控<span>1</span></a></li>
		
			<li><a href="/tags/教程/">教程<span>1</span></a></li>
		
			<li><a href="/tags/问题记录/">问题记录<span>2</span></a></li>
		
			<li><a href="/tags/消息队列/">消息队列<span>1</span></a></li>
		
			<li><a href="/tags/容器化技术，转载/">容器化技术，转载<span>1</span></a></li>
		
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>最新文章</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2019/06/08/走近Python密码学/" ><i class="fa fa-file-o"></i>走近Python密码学</a>
      </li>
    
      <li>
        <a href="/2019/01/11/如何托管微信小程序注册-2/" ><i class="fa fa-file-o"></i>如何托管微信小程序注册(2)</a>
      </li>
    
      <li>
        <a href="/2018/12/16/如何托管微信小程序注册-1/" ><i class="fa fa-file-o"></i>如何托管微信小程序注册(1)</a>
      </li>
    
      <li>
        <a href="/2018/09/26/怎样使用hexo生成自己的githup主页/" ><i class="fa fa-file-o"></i>怎样使用Hexo生成自己的github主页</a>
      </li>
    
      <li>
        <a href="/2018/08/05/glances实现服务器资源监控/" ><i class="fa fa-file-o"></i>glances实现服务器资源监控</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>链接</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="https://github.com/blackshow" title="blackshow's Github repository." target="_blank"]);">原作者地址</a></li>
	
		<li><i class="fa fa-github"></i><a href="https://github.com/blackshow/hexo-theme-freemind.386" title="Freemind.386's Github repository." target="_blank"]);">主题地址</a></li>
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/deimo" title="My Github account." target="_blank"]);">我的gihub地址</a></li>
	
		<li><i class="fa fa-zhihu"></i><a href="https://www.zhihu.com/" title="My Github account." target="_blank"]);">知乎发现</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2019 DeiMo
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.    
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
